{% extends 'base.html' %}
{% block content %}
    <div class="container mt-3">
        <div class="row">
            {% include "_modal.html" %}
            <div class="row">
                <div class="col-12 mb-3">
                    <button id="create-obj-async"
                            class="btn btn-primary"
                            type="button"
                            name="button">
                        <span class="fa fa-plus mr-2"></span>Create obj - Asynchronous
                    </button>
                    <button id="filter-obj"
                            class="filter-obj btn btn-primary"
                            type="button"
                            name="button"
                            data-form-url="{% url 'crm:filter_obj' %}">
                        <span class="fa fa-filter mr-2"></span>Filter objs
                    </button>
                </div>
                <div class="col-12 mb-3">
                    {% if 'type' in request.GET %}<p class="filtered-objs">Filtered objs</p>{% endif %}
                    {% include "crm/_objs_table.html" %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
{% block extrascripts %}
    <script type="text/javascript">
        $(function() {

            // Create obj asynchronous button
            // message
            var asyncSuccessMessageCreate = [
                "<div ", "style='position:fixed;top:0;z-index:10000;width:100%;border-radius:0;' ", "class='alert alert-icon alert-success alert-dismissible fade show mb-0' role='alert'>",
                "Success: Obj was created.",
                "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>",
                "<span aria-hidden='true'>&times;</span>",
                "</button>",
                "</div>",
                "<script>",
                "$('.alert').fadeTo(2000, 500).slideUp(500, function () {$('.alert').slideUp(500).remove();});",
                "<\/script>"
            ].join("");

            // modal form
            function createObjAsyncModalForm() {
                $("#create-obj-async").modalForm({
                    formURL: "{% url 'crm:create_obj' %}",
                    modalID: "#create-modal",
                    asyncUpdate: true,
                    asyncSettings: {
                        closeOnSubmit: true,
                        successMessage: asyncSuccessMessageCreate,
                        dataUrl: "objs/",
                        dataElementId: "#objs-table",
                        dataKey: "table",
                        addModalFormFunction: reinstantiateModalForms
                    }
                });
            }
            createObjAsyncModalForm();

            // Update obj asynchronous button
            // message
            var asyncSuccessMessageUpdate = [
                "<div ", "style='position:fixed;top:0;z-index:10000;width:100%;border-radius:0;' ", "class='alert alert-icon alert-success alert-dismissible fade show mb-0' role='alert'>",
                "Success: Obj was updated.",
                "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>",
                "<span aria-hidden='true'>&times;</span>",
                "</button>",
                "</div>",
                "<script>",
                "$('.alert').fadeTo(2000, 500).slideUp(500, function () {$('.alert').slideUp(500).remove();});",
                "<\/script>"
            ].join("");

            // modal form
            function updateObjModalForm() {
                $(".update-obj").each(function() {
                    $(this).modalForm({
                        formURL: $(this).data("form-url"),
                        asyncUpdate: true,
                        asyncSettings: {
                            closeOnSubmit: true,
                            successMessage: asyncSuccessMessageUpdate,
                            dataUrl: "objs/",
                            dataElementId: "#objs-table",
                            dataKey: "table",
                            addModalFormFunction: reinstantiateModalForms
                        }
                    });
                });
            }
            updateObjModalForm();

            // Delete obj buttons - formURL is retrieved from the data of the element
            function deleteObjModalForm() {
                $(".delete-obj").each(function() {
                    $(this).modalForm({
                        formURL: $(this).data("form-url"),
                        isDeleteForm: true
                    });
                });
            }
            deleteObjModalForm();

            // Read obj buttons
            function readObjModalForm() {
                $(".read-obj").each(function() {
                    $(this).modalForm({
                        formURL: $(this).data("form-url")
                    });
                });
            }
            readObjModalForm();

            function reinstantiateModalForms() {
                createObjAsyncModalForm();
                readObjModalForm();
                updateObjModalForm();
                deleteObjModalForm();
            }

            // Filter objs button
            $("#filter-obj").each(function() {
                $(this).modalForm({
                    formURL: $(this).data("form-url")
                });
            });

            // Hide message
            $(".alert").fadeTo(2000, 500).slideUp(500, function() {
                $(".alert").slideUp(500);
            });
        });
    </script>
{% endblock extrascripts %}
